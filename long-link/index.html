<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>长链接生成器</title>
    <link rel="shortcut icon" href="https://cdn.micono.eu.org/icon/logo.png" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript">
        ((c, l, a, r, i, t, y) => {
            c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
            t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
            y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
        })(window, document, "clarity", "script", "spxwf705l5");
    </script>
    <link rel="stylesheet" href="https://cdn.oplist.org/gh/YangRucheng/EdgeOne-Pages@main/assets/css/link.css">
</head>

<body>
    <div class="container" id="main">
        <h2>长链接生成器</h2>

        <div id="generator">
            <div class="label">原始链接：</div>
            <input type="text" id="input" placeholder="请输入要生成的原始链接~">

            <div class="label">长链接：</div>
            <input type="text" id="output" placeholder="点击复制" readonly>

            <button class="btn" id="genBtn">生成长链接</button>
        </div>

        <div id="redirect" style="display:none;">
            <a id="redirectLink" class="btn" href="#" target="_blank" referrerpolicy="no-referrer">前往原始链接</a>
        </div>
    </div>

    <script>
        const chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";

        const encodeBase36 = str => {
            const bytes = new TextEncoder().encode(str);
            let num = 0n;
            for (let b of bytes) num = (num << 8n) + BigInt(b);
            return num.toString(36).toUpperCase();
        };

        const decodeBase36 = b36 => {
            let num = 0n;
            for (const c of b36) num = num * 36n + BigInt(chars.indexOf(c));
            let hex = num.toString(16);
            if (hex.length % 2) hex = "0" + hex;
            const bytes = new Uint8Array(hex.length / 2);
            for (let i = 0; i < bytes.length; i++) bytes[i] = parseInt(hex.substr(i * 2, 2), 16);
            return new TextDecoder().decode(bytes);
        };

        const normalizeUrl = url =>
            url.startsWith("http://") || url.startsWith("https://") ? url : `https://${url}`;

        const randomPad = len => {
            let pad = '';
            for (let i = 0; i < Math.max(len, 3); i++)
                pad += chars[Math.floor(Math.random() * chars.length)];
            return pad;
        };

        const generateLink = () => {
            let text = document.getElementById("input").value.trim();
            if (!text) return alert("欸~ 主人要先输入原始链接哦~♡");
            text = normalizeUrl(text);
            const encoded = encodeBase36(text);
            document.getElementById("output").value = `${location.origin}${location.pathname}?d=${encoded}&pad=${randomPad(120 - encoded.length)}`;
            document.getElementById("output").onclick = () =>
                navigator.clipboard.writeText(document.getElementById("output").value);
        };

        const init = () => {
            const params = new URLSearchParams(location.search);
            const d = params.get("d");
            if (!d) return;
            const decoded = normalizeUrl(decodeBase36(d));
            document.getElementById("generator").style.display = "none";
            document.getElementById("redirect").style.display = "block";
            const link = document.getElementById("redirectLink");
            link.href = decoded;
        };

        document.getElementById("genBtn").onclick = generateLink;
        init();
    </script>
</body>

</html>